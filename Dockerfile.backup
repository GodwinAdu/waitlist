FROM node:18-alpine

# Install cron and mongodb-tools
RUN apk add --no-cache dcron mongodb-tools

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .

# Setup cron job
RUN echo "0 2 * * * cd /app && npm run backup create" > /etc/crontabs/root

# Start both app and cron
CMD ["sh", "-c", "crond -f -d 8 & npm start"]